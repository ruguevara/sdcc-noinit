ZX-Spectrum libraries for SDCC+ASM+buld scripts

Сборочная система для ZX.
ZX-Specrum, ZX-Evolution и т.д.


Сборочная система для ZX предназначена для облегчения сборки проектов для ZX-Spectrum-совместимых ПК.
Система базируется на пакете SDCC состоит из набора конфигурационных скриптов.
Система позволяет собирать множество программ сразу, с отдельной конфигурации для каждой из них.

Структура сборочной системы.

1. Головной каталог:
	apps		- каталог, содеращий исходники собираемых программ. Одна программа - один подкаталог.
			Выходные файлы:
				Для программ:
					*.tap
					*.$C
					*.tap
				Для плагинов WC:
					*.wmf
			Если что-то не нравится - всегда можно поправить Makefile конкретной программы.
	
	configs 	- файлы конфигурации, определяющие какие программы и библиотеки и как собирать.
	
	include 	- заголовочные файлы, которые доступны все библиотекам и программам всегда.
			
	libsrc		- каталог, содеращий исходники собираемых библиотек. Одна библиотека - один подкаталог.
			При сборке доступны заголовочные файлы только тех библиотек, которые разрешены.
			
	scripts 	- скрипты, используемые для сборки (перемещение памяти, преобразование текста, автогенерация файлов ...)
	
	Makefile	- Головной Makefile.

2. Сборка
	Сборка ПО производится в 2 этапа:
	
	- Собираются библиотеки из libsrc.
	В момент сборки библиотеками доступны заголовочные файлы
	других тех библиотек, которые разрешены в данной сборке.
	
	- Собираются прорграммы, плагины и всё что хотите из apps.
	При сборке доступны заголовочные файлы только тех библиотек, которые разрешены и сами разрешенные библиотеки.

3. Конфигурация
	Конфигурация имеется глобальная (файлы находятся в каталоге configs)
	и локальная (*.mk файлы в каталоге конкретной программы в apps).
	В каталоге каждой программы имеется файл config.mk, в котором описаны параметы данной программы, такие как
	адрес загрузки и запуска данной программы, размер стека, разрешение прерываний по запуску программы и проч.
	На основе файла config.mk генерируется стартовый код для программы.
	
	Глобальная конфигурация доступна всем программам и библиотекам и разбита на отдельные текстовые *.mk-файлы
	для удобства.
	
	Любой *.mk-файл из каталога configs будет добавлен в описание глобальной конфигурации.
	Любой *.mk-файл из каталога программы будет добавлен в описание локальной конфигурации.
	
4. Добавление новой программы в систему сборки.
	Шаг 1. Создать каталог apps/myprogram (myprogram - имя вашей программы)
	Шаг 2. Скопировать файлы сбоки программы config.mk и Makefile, например из apps/testapps в каталог
		apps/myprogram
	Шаг 3. Отредактировать, при необходимости файл локальной конфигурации apps/myprogram/config.mk
	Шаг 5. Указать ваши исходные файлы и имя программы в файле apps/myprogram/Makefile.
	
		Указать имя программы в файле apps/myprogram/Makefile:
		
		APP=myprogram
	
		Например, ваши исходные файлы называются prog.c (C-код) и vid.s (ASM-код), значит в файле apps/myprogram/Makefile
		надо найти переменную OBJS= и указать в ней
		
		OBJS=prog.rel vid.rel
	
	Шаг 6. Разрешить компиляцию вашей программы в глобальной конфигурации, для чего в файле configs/apps.mk указать
		
		APPLICATIONS+=myprogram
	Все.
	
	Теперь, если в головном каталоге набрать
	
		# make
		
	то пойдет сборка и у вас (при отсутствии ошибок) появится каталог bin, в котором будут находиться файлы
	myprogram.tap myprogram.$C myprogram.tap myprogram.bin
	
	Для сборки WC-плагинов процесс аналгичный, только config.mk и Makefile надо брать из apps/wcplugin.
	-----------------
	* ВНИМАНИЕ! Пока что собираются плагины размером в 1 страницу 16К. *
	-----------------
	Плагин в каталог bin помешается с расширением *.wmf
	
4. Файлы глобальной конфигурации.
	Файлы глобальной конфигурации содержат переменные, определяющие процесс сборки.
	Они МОГУТ перекрываться переменными для файлов локальной конфигурации.
	
	# Указывает какие программы-плагины собирать
	apps.mk
	
	# Указывает шаблон стартового кода для программ
	crt0.mk
	
	# Указывает шаблон стартового кода для WC-плагинов
	crt0wcplugin.mk
	
	# Указывает какие библиотеки собирать
	library.mk
	
	# Использовать плавающую точку в printf или нет (сильно влияет на размер)
	printf_float.mk
	
	# Указать - стандартная реализвация float или моя.
	sfs_float.mk
	
	# Определяет какие утилиты использовать. Менять можно, но очень-очень осторожно:)
	tools.mk

5. Файлы локальной конфигурации программ.
	Файлы локальной конфигурации программ расположен в каталоге программы (например apps/myprogram/config.mk).
	На основе файла config.mk генерируется стартовый код для конкретной программы.
	
	Параметры, указываемые в данном файле:
	
		# Адрес начала программы, он же адрес запуска
		START=0x6000

		# Размер стека, он располагается сразу за программой
		SSIZE=0x0400

		# Если =1, то при старте программы прерывания запрещаются,
		# а при выходе - разрешаются.
		DISTART=0

		# Если CALLERSTACK=1, то
		# сохранять при входе значение SP,
		# а при выходе восстанавливать его.
		# Иначе - забить и просто при входе установить стек куда надо.
		CALLERSTACK=0

6. Файлы локальной конфигурации WC-плагинов.
	Параметры, указываемые в файле для WC-плагина:
	
		# Адрес запуска плагина (а вдруг когда поменяют?)
		START=0x8000
		
		# Адрес описателя-заголовка плагина (а вдруг когда поменяют?)
		STARTPLHEADER=0x6000

